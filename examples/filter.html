<!DOCTYPE html>
<html>
  <head>
    <!-- Load JQuery and JQuery-UI -->
    <link type="text/css" href="css/smoothness/jquery-ui-1.7.2.custom.css" rel="stylesheet" />  
    <script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.7.2.custom.min.js"></script>
    
    <!-- Load Processing.js -->
    <script language="javascript" src="js/processing.js"></script>
    <script language="javascript" src="js/init.js"></script>

    <!-- Load DSP.js -->
    <script src="../dsp.js"></script>
    <script>
      $(function() {
        $('#cutoff').slider({ orientation: 'vertical', range: 'min', min: 60, max: 5000, step: 1, value: 880 });
        $('#res').slider({ orientation: 'vertical', range: 'min', min: 1.0, max: 20.0, value: 1.0, step: 0.01 });
      });
    </script>

    <style type="text/css">
      body, * {
        font-family: Arial, sans-serif;
      }
      .control {
        padding: 5px;
        border: 1px outset #CCC;
        background-color: #EEE;
        float: left;
        margin-right: 5px;
      }
      .control table td {
        padding: 10px;
        width: 20px;
        color: #999;
        font-size: 12px;
      }
      .control h3 {
        margin: 0;
        padding:0;
        font-size: 12px;
        margin-bottom: 10px;
      }
      .control #debug {
        border: 1px inset #ccc;
        background-color: #FFF;
        font-size: 12px;
        width: 300px;
        padding: 10px;
      }
      .slider {
        margin-bottom: 16px;
        width: 8px;
      }
      
      .ui-slider .ui-slider-handle {
        width: 8px;
        margin-left: 3px;
      }
    </style>
  </head>
  <body>
    <script>
      // Setup shared variables
      var sampleRate = 44100;
      var bufferSize = 1024;
      
      var audioBuffer = [];
      var notPlaying = true;
      
      var signal = [];
      var lp12;

      var writeCount = 0;
      
      // Setup experimental audio out
      var output = new Audio();
      
      if ( typeof output.mozSetup === 'function' ) {
        output.mozSetup(1, sampleRate, 1);
      }
      
      var audioWriter = function(s) {     
        lp12.set($('#cutoff').slider('option', 'value'), $('#res').slider('option', 'value'));
        lp12.process(s);
                
        output.mozWriteAudio(s.length, s);
        writeCount++;
      }
      
      function audioWritten(event) {
        var mozSignal = event.mozFrameBuffer;

        // Convert mozSignal to native js array
        if ( mozSignal.length <= 4096 ) {
          for ( var i = 0; i < mozSignal.length / 2; i++ ) {
            if ( mozSignal.item(i) != 0 ) {
              signal[i] = (mozSignal.item(2*i));// + mozSignal.item(2*i+1));
              //signal[i] = mozSignal.item(i);
            }
          }
        
          setTimeout(audioWriter, 0, signal);
        }
      }
    </script>
    
    <script type="application/processing" target="#signal">
      void setup() {
        size(512, 200);
        lp12 = new LP12(22050, 0, sampleRate);
        //lp12.set($('#cutoff').slider('option', 'value'), $('#res').slider('option', 'value'));
        stroke(255);
        strokeWeight(1);
      }
      
      void draw() {
        background(100, 100, 200);
        for (int i = 0; i < signal.length / 4; i++) {
          line(i, height/2 - signal[4*i]/2 * 200, i, height/2 + signal[4*i]/2 * 200);
        }
      }
    </script>
    
    <h1>Audio Filter</h1>
    <p>Applies a Low pass filter to an audio stream. Remember to <b>Mute</b> the audio to hear the pure filtered sound.</p>

    <audio id='input' tabindex="0" src="cj_wakbreak2et.ogg" controls="true" onaudiowritten="audioWritten(event);" style="width: 512px;"></audio><br>

    <div style="width: 620px;">
      <div><canvas id="signal" width="512px" height="200px" style="float: left;"></canvas></div>
      
      <div class="control" style="float: right; height: 188px">
        <h3>Low Pass Filter</h3>
        <table>
          <tr>
            <td><div id="cutoff" class="slider"></div>F</td>
            <td><div id="res" class="slider"></div>Q</td>
          </tr>
        </table>
      </div>
    </div>
  </body>
</html>
